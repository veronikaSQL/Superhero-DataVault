INSERT OVERWRITE INTO DATA_VAULT.SAT_SML_BEING
WITH MARVEL AS
(
SELECT PARSE.*,s.*
FROM
    ( 
    SELECT
    JSON_RAW:urls.wikipedia::string as SOURCE_URL 
    ,'MARVEL_SEARCH:'||SOURCE_URL AS URL
    , MD5(URL) AS HUB_BEING_KEY
    , ARRAY_TO_STRING(JSON_RAW:aliases::ARRAY,',') AS ALIASES
    from "SUPERHERO"."DEMO"."SUPERHEROES_MARVEL_SEARCH"
    WHERE JSON_RAW:urls.wikipedia IS NOT NULL
    ) PARSE
    , LATERAL FLATTEN (INPUT => SPLIT(PARSE.ALIASES,',')) s
  )
  ,SUPERDB AS
( SELECT PARSE.*,s.*
  FROM
      ( 
   SELECT DISTINCT
      'https://www.superherodb.com'||URL as SOURCE_URL 
      ,'SUPERHERODB:'||SOURCE_URL AS URL
      , MD5(URL) AS HUB_BEING_KEY
      , ALIASES
      from "SUPERHERO"."DEMO"."SUPERHEROES_RAW"
    WHERE URL IS NOT NULL
    ) PARSE
    , LATERAL FLATTEN (INPUT => SPLIT(PARSE.ALIASES,',')) s
  )
  
  SELECT DISTINCT
  MD5(  MARVEL.URL || '||' || SUPERDB.URL ) AS SML_BEING_KEY
  , MARVEL.HUB_BEING_KEY AS HUB_BEING_KEY_1
  , SUPERDB.HUB_BEING_KEY AS HUB_BEING_KEY_2
  , MARVEL.URL AS URL_1
  , SUPERDB.URL AS URL_2
  , MARVEL.VALUE AS VALUE_1
  , SUPERDB.VALUE AS VALUE_2
  , MARVEL.THIS AS ALIASES_1
  , SUPERDB.THIS AS ALIASES_2
   ,current_timestamp()::timestamp_tz as LOAD_TIME
  FROM MARVEL 
    JOIN SUPERDB
  ON MARVEL.VALUE = SUPERDB.VALUE
   WHERE  MARVEL.VALUE <> '' ;
   
